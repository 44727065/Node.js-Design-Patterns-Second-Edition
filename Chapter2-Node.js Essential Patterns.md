# Node.js Essential Patterns
对于`Node.js`而言，异步特性是其最显著的特征，但对于别的一些语言，例如`PHP`，就不常处理异步代码。

在同步的编程中，我们习惯于把代码的执行想象为自上而下连续的执行计算步骤。每个操作都是阻塞的，这意味着只有在一个操作执行完成后才能执行下一个操作，这种方式利于我们理解和调试。

然而，在异步的编程中，我们可以在后台执行诸如读取文件或执行网络请求的一些操作。当我们在调用异步操作方法时，即使当前或之前的操作尚未完成，下面的后续操作也会继续执行，在后台执行的操作会在任意时刻执行完毕，并且应用程序会在异步调用完成时以正确的方式做出反应。

虽然这种非阻塞方法相比于阻塞方法性能更好，但它实在是让程序员难以理解，并且，在处理较为复杂的异步控制流的高级应用程序时，异步顺序可能会变得难以操作。

`Node.js`提供了一系列工具和设计模式，以便我们最佳地处理异步代码。了解如何使用它们编写性能和易于理解和调试的应用程序非常重要。

在本章中，我们将看到两个最重要的异步模式：回调和事件发布器。

## 回调模式
在上一章中介绍过，回调是`reactor模式`的`handler`的实例，回调本来就是`Node.js`独特的编程风格之一。回调函数是在异步操作完成后传播其操作结果的函数，总是用来替代同步操作的返回指令。而`JavaScript`恰好就是表示回调的最好的语言。在`JavaScript`中，函数是一等公民，我们可以把函数变量作为参数传递，并在另一个函数中调用它，把调用的结果存储到某一数据结构中。实现回调的另一个理想结构是闭包。使用闭包，我们能够保留函数创建时所在的上下文环境，这样，无论何时调用回调，都保持了请求异步操作的上下文。

在本节中，我们分析基于回调的编程思想和模式，而不是同步操作的返回指令的模式。

### [CPS](https://en.wikipedia.org/wiki/Continuation-passing_style)
在`JavaScript`中，回调函数作为参数传递给另一个函数，并在操作完成时调用。在函数式编程中，这种传递结果的方法被称为`CPS`。这是一个一般概念，而且不只是对于异步操作而言。实际上，它只是通过将结果作为参数传递给另一个函数（回调函数）来传递结果，然后在主体逻辑中调用回调函数拿到操作结果，而不是直接将其返回给调用者。

### 同步CPS
为了更清晰地理解`CPS`，让我们来看看这个简单的同步函数：

```javascript
function add(a, b) {
  return a + b;
}
```

上面的例子成为直接编程风格，其实没什么特别的，就是使用`return`语句把结果直接传递给调用者。它代表的是同步编程中返回结果的最常见方法。上述功能的`CPS`写法如下：

```javascript
function add(a, b, callback) {
  callback(a + b);
}
```

`add()`函数是一个同步的`CPS`函数，`CPS`函数只会在它调用的时候才会拿到`add()`函数的执行结果，下列代码就是其调用方式：

```javascript
console.log('before');
add(1, 2, result => console.log('Result: ' + result));
console.log('after');
```